# Nacos

- 一个更易于构建云原生应用的动态**服务发现**、**配置管理**和**服务管理平台**。
- Nacos: Dynamic Naming and Configuration Service
- Nacos = Eureka + Config + Bus
- 启动报错
  - https://blog.csdn.net/qq_47768542/article/details/114179156

 

## 1. 配置

1. 父pom

   1. ```xml
      <dependency>
          <groupId>com.alibaba.cloud</groupId>
          <artifactId>spring-cloud-alibaba-dependencies</artifactId>
          <version>2.1.0.RELEASE</version>
          <type>pom</type>
          <scope>import</scope>
      </dependency>
      ```

   2. 本pom

      1. ```xml
         <!--SpringCloud ailibaba nacos -->
         <dependency>
             <groupId>com.alibaba.cloud</groupId>
             <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
         </dependency>
         ```

   3. yaml

      1. ```yaml
         server:
           port: 9001
         
         spring:
           application:
             name: nacos-payment-provider
           cloud:
             nacos:
               discovery:
                 server-addr: localhost:8848 #配置Nacos地址
         
         management:
           endpoints:
             web:
               exposure:
                 include: '*'
         ```

      2. ```properties
         server.port=8081
         spring.application.name = api-gateway
         spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848
         management.endpoints.web.exposure.include=*
         ```

      3. 

   4. 主启动

      1. ```java
         @EnableDiscoveryClient
         @SpringBootApplication
         public class PaymentMain9001
         {
             public static void main(String[] args) {
                 SpringApplication.run(PaymentMain9001.class, args);
             }
         }
         ```

## 2. 服务配置中心

- ```yaml
  server:
    port: 8002
  
  spring:
    application:
      name: cloud_service_member
    # 配置 nacos
    cloud:
      nacos:
        discovery:
          server-addr: localhost:8848
    datasource:
      type: com.alibaba.druid.pool.DruidDataSource            # 当前数据源操作类型
      driver-class-name: org.gjt.mm.mysql.Driver              # mysql驱动包 com.mysql.jdbc.Driver
      url: jdbc:mysql://localhost:3306/saas?useUnicode=true&characterEncoding=utf-8&useSSL=false
      username: root
      password: root
      druid:
        test-on-borrow: false
        test-while-idle: true
        test-on-return: false
        validation-query: select 1
    profiles:
      active: ${environment}
    jpa:
      properties:
        hibernate:
          dialect: org.hibernate.dialect.MySQL5Dialect
      hibernate:
        naming:
          physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
  
  ```

- Spring 2.4以后需要加入spring-cloud-starter-bootstrap依赖

- bootstrap.properties

  - ```
    加载顺序
    若application.yml 和bootstrap.yml 在同一目录下：bootstrap.yml 先加载 application.yml后加载
    
    bootstrap.yml 用于应用程序上下文的引导阶段。bootstrap.yml 由父Spring ApplicationContext加载。
    
    配置区别
    bootstrap.yml 和 application.yml 都可以用来配置参数。
    
    bootstrap.yml 用来程序引导时执行，应用于更加早期配置信息读取。可以理解成系统级别的一些参数配置，这些参数一般是不会变动的。一旦bootStrap.yml 被加载，则内容不会被覆盖。
    
    application.yml 可以用来定义应用级别的， 应用程序特有配置信息，可以用来配置后续各个模块中需使用的公共参数等。
    
    属性覆盖问题
    启动上下文时，Spring Cloud 会创建一个 Bootstrap Context，作为 Spring 应用的 Application Context 的父上下文。
    
    初始化的时候，Bootstrap Context 负责从外部源加载配置属性并解析配置。这两个上下文共享一个从外部获取的 Environment。Bootstrap 属性有高优先级，默认情况下，它们不会被本地配置覆盖。
    
    也就是说如果加载的 application.yml 的内容标签与 bootstrap 的标签一致，application 也不会覆盖 bootstrap，而 application.yml 里面的内容可以动态替换。
    
    bootstrap.yml典型的应用场景
    当使用 Spring Cloud Config Server 配置中心时，这时需要在 bootstrap.yml 配置文件中指定 spring.application.name 和 spring.cloud.config.server.git.uri，添加连接到配置中心的配置属性来加载外部配置中心的配置信息
    一些固定的不能被覆盖的属性
    一些加密/解密的场景
    ```

- Nacos 动态刷新 `@RefreshScope` 实现配置自动刷新

- 配置文件名称：`${spring.application.name}-${profile}. ${file-extension:properties}`

  - prefix 默认为 spring.application.name 的值
  - spring.profile.active 即为当前环境对应的 profile，可以通过配置项 spring.profile.active 来配置。
  - file-exetension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置

